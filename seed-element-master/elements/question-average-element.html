<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/font-roboto/roboto.html">
<link rel="import" href="/bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="/bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="/bower_components/core-menu/core-menu.html">
<link rel="import" href="/bower_components/core-menu/core-submenu.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/seed-element-master/elements/star-rating-element.html">
<script type="text/javascript" src="/bower_components/underscore/underscore.js"></script>  

<polymer-element name="question-average-element" attributes="projects background filter">
  <template>
    <style>
      :host {
        position: relative;
        background-color: #6bc177;
        padding-top:64px;
        color: rgb(255, 255, 255);
        overflow: hidden;
        user-select: none;
      }
  
      .circle {
        opacity: 0.6;
        margin: auto;
        position: relative;
        left: 50%;
        transform: translateX(-50%);
      }

      .spec {
        position: absolute;
        text-align: center;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      #npa-item
      {
        color: #8bc34a;
        font-size:120px;
        text-align:right;
      }

      #npa_header
      {
        text-align: center;
      }

      #npa_number
      {
        text-align: center;
        font-size: 70px;
        margin-bottom: 20px;
      }

      #question
      {
        text-align:center;
        margin: 10px;
      }

      .avg-number
      {
        font-size: 30px;
        margin: 10px;
      }

    </style>
    <div vertical layout relative fit>

      <div horizontal flex two justified layout center>
          <div vertical flex>
            <div flex relative>
              <svg class="circle" width="{{npa_score/10.0 * 100}}%" viewBox="0 0 100 100">
                <circle r="50" cx="50" cy="50" fill={{backgrounds[1]}} />
              </svg>
              <div class="spec" vertical center-justified layout>
                <div id="question">NPA</div>
                <div class="avg-number">{{npa_score}}</div>
              </div>
            </div>
          </div>

          <div vertical flex>
            <div flex relative> 
              <svg class="circle" width="{{all_average/5.0 * 100}}%" viewBox="0 0 100 100">
                <circle r="50" cx="50" cy="50" fill={{backgrounds[4]}} />
              </svg>
              <div class="spec" vertical center-justified layout>
                  <div id="question">All</div>
                  <div class="avg-number">{{all_average}}</div>
              </div>
            </div>
          </div>
      </div>

      <div horizontal flex justified layout center>
          <template repeat="{{ avg, avgIndex in averages_by_topic }}">
            <div vertical flex>
              <div flex relative>
                <svg class="circle" width="{{avg.average/5.0 * 100}}%" viewBox="0 0 100 100">
                  <circle r="50" cx="50" cy="50" fill={{backgrounds[avgIndex]}} />
                </svg>
                <div class="spec" vertical center-justified layout>
                  <div class="avg-number">{{avg.average}}</div>
                </div>
              </div>
              <div flex id="question">{{avg.topic}}</div>
            </div>
          </template>
      </div>

    </div>
  </template>
  <script>
  Polymer('question-average-element', {
    backgrounds: ['#67b672', '#64ad6e', '#60a66a', '#5c9d65', '#57905f'],
    projectsChanged: function(oldvalue, newvalue)
    {
        var avg_arr = _.chain(newvalue)
            .reduce(function(memo, val){ return memo.concat(val.value.questions).concat({topic: 'npa_score', answer: val.value.npa_score}); }, [])
            .groupBy(function(val){ return val.topic; })
            .map(function(value, key){
              var avg = _.reduce(value, function(memo, ans) {return {i : (memo.i + 1), avg: (memo.avg * memo.i + ans.answer)/(memo.i+1)} }, {i: 0, avg: 0.0});
              return {topic: key, average: avg.avg}; })
            .value();
        this.npa_score = _.last(avg_arr).average.toFixed(1);
        var sans_npa = _.initial(avg_arr);
        this.averages_by_topic = _.map(sans_npa, function(elem){return {topic: elem.topic, average: elem.average.toFixed(1)};});
        this.all_average = _.reduce(sans_npa, function(memo, ans) {
          return {i : (memo.i + 1), avg: (memo.avg * memo.i + parseFloat(ans.average))/(memo.i+1)} }, {i: 0, avg: 0.0}).avg.toFixed(1); 
    },
    ready: function(){
    }
  });
  </script>
</polymer-element>
