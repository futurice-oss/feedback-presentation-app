<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/font-roboto/roboto.html">
<link rel="import" href="/bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="/bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="/bower_components/core-menu/core-menu.html">
<link rel="import" href="/bower_components/core-menu/core-submenu.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/seed-element-master/elements/star-rating-element.html">
<script type="text/javascript" src="/bower_components/underscore/underscore.js"></script>  

<polymer-element name="question-average-element" attributes="projects background filter">
  <template>
    <style>
      :host {
        position: relative;
        background-color: #6bc177;
        padding-top:64px;
        color: rgb(255, 255, 255);
        overflow: hidden;
        user-select: none;
      }
  
      .circle {
        margin: auto;
        position: relative;
        left: 50%;
        transform: translateX(-50%);
      }

      .spec {
        position: absolute;
        text-align: center;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      #npa-item
      {
        color: #8bc34a;
        font-size:120px;
        text-align:right;
      }

      #npa_header
      {
        text-align: center;
      }

      #npa_number
      {
        text-align: center;
        font-size: 70px;
        margin-bottom: 20px;
      }

      #question
      {
        text-align:center;
        margin: 10px;
      }

      .avg-number
      {
        font-size: 30px;
        margin: 10px;
      }

    </style>
    <div vertical layout relative fit>
      <div horizontal flex justified layout center relative fit>
            <template repeat="{{ avg in averages_by_topic }}">
            <div vertical flex>
              <div flex relative>
                <svg class="circle" width="{{avg.average/5.0 * 100}}%" viewBox="0 0 100 100">
                  <circle r="50" cx="50" cy="50" fill="red" />
                </svg>
                  <div class="spec" vertical center-justified layout>
                    <div class="avg-number">{{avg.average}}</div>
                  </div>
              </div>
              <div flex id="question">{{avg.topic}}</div>
            </div>
            </template>
        </div>
      <div>
    </div>
  </template>
  <script>
  Polymer('question-average-element', {
    projectsChanged: function(oldvalue, newvalue)
    {
        this.averages_by_topic = _.chain(newvalue)
            .reduce(function(memo, val){ return memo.concat(val.value.questions); }, [])
            .groupBy(function(val){ return val.topic; })
            .map(function(value, key){
              var avg = _.reduce(value, function(memo, ans) {return {i : (memo.i + 1), avg: (memo.avg * memo.i + ans.answer)/(memo.i+1)} }, {i: 0, avg: 0.0});
              return {topic: key, average: avg.avg.toFixed(1)}; })
            .value();
    },
    ready: function(){
    }
  });
  </script>
</polymer-element>
